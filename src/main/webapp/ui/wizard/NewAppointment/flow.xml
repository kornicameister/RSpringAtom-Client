<?xml version="1.0" encoding="UTF-8"?>
<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~ This file is part of [SpringAtom] Copyright [kornicameister@gmail.com][2013]                  ~
  ~                                                                                               ~
  ~ [SpringAtom] is free software: you can redistribute it and/or modify                          ~
  ~ it under the terms of the GNU General Public License as published by                          ~
  ~ the Free Software Foundation, either version 3 of the License, or                             ~
  ~ (at your option) any later version.                                                           ~
  ~                                                                                               ~
  ~ [SpringAtom] is distributed in the hope that it will be useful,                               ~
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of                                ~
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                 ~
  ~ GNU General Public License for more details.                                                  ~
  ~                                                                                               ~
  ~ You should have received a copy of the GNU General Public License                             ~
  ~ along with [SpringAtom].  If not, see <http://www.gnu.org/licenses/gpl.html>.                 ~
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

<!--suppress XmlPathReference -->
<flow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      parent="wizard"
      start-state="step1"
      xmlns="http://www.springframework.org/schema/webflow"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          http://www.springframework.org/schema/webflow/spring-webflow.xsd">


    <on-start>
        <evaluate expression="'NewAppointmentWizard'" result="flowScope.wizardID"/>
        <evaluate expression="'NewAppointmentWizardForm'" result="flowScope.formID"/>
    </on-start>

    <view-state id="step1" view="ui.wizard.NewAppointment.1" model="appointment" popup="true">
        <binder>
            <binding property="car" required="true"/>
            <binding property="assignee" required="true"/>
            <binding property="reporter" required="true"/>
            <binding property="beginDate" required="true"/>
            <binding property="beginTime" required="true"/>
            <binding property="endDate" required="true"/>
            <binding property="endTime" required="true"/>
        </binder>
        <on-entry>
            <evaluate expression="SAppointmentFormService.getNewAppointment(false)"
                      result="flowScope.appointment"
                      result-type="org.agatom.springatom.server.model.beans.appointment.SAppointment"/>
            <evaluate expression="SAppointmentFormService.cars" result="viewScope.cars"/>
            <evaluate expression="SAppointmentFormService.assignees" result="viewScope.assignees"/>
            <evaluate expression="SAppointmentFormService.reporters" result="viewScope.reporters"/>
        </on-entry>
        <transition on="next" to="step2" validate="false"/>
        <transition on="cancel" to="cancel" history="invalidate" bind="false"/>
    </view-state>

    <view-state id="step2" view="ui.wizard.NewAppointment.2" model="newTask" popup="true">
        <binder>
            <binding property="task" required="false"/>
            <binding property="type" required="true"/>
        </binder>
        <on-entry>
            <evaluate expression="SAppointmentFormService.newTask"
                      result="flowScope.newTask"
                      result-type="org.agatom.springatom.server.model.beans.appointment.SAppointmentTask"/>
            <evaluate expression="appointment.tasks"
                      result="viewScope.tasks"/>
        </on-entry>
        <transition on="addTask" to="step2">
            <evaluate expression="SAppointmentFormService.addNewTask(flowScope.appointment, newTask)"/>
        </transition>
        <transition on="removeTask" to="step2" bind="false">
            <evaluate expression="SAppointmentFormService.removeTask(flowScope.appointment, currentEvent.attributes.getString('rtai'))"/>
        </transition>
        <transition on="previous" to="step1"/>
        <transition on="next" to="step3">
            <evaluate expression="SAppointmentFormService.addNewTask(flowScope.appointment, newTask)"/>
        </transition>
        <transition on="cancel" to="cancel" history="invalidate"/>
    </view-state>

    <view-state id="step3" view="ui.wizard.NewAppointment.3" popup="true">
        <on-entry>
            <evaluate expression="flowScope.appointment"
                      result="viewScope.finalResultAppointment"
                      result-type="org.agatom.springatom.server.model.beans.appointment.SAppointment"/>
        </on-entry>
        <transition on="finish" to="success" history="invalidate">
            <evaluate expression="SAppointmentService.save(flowScope.appointment)"
                      result="flowScope.appointment"
                      result-type="org.agatom.springatom.server.model.beans.appointment.SAppointment"/>
        </transition>
        <transition on="cancel" to="cancel" history="invalidate"/>
    </view-state>

    <end-state id="success"
               view="externalRedirect:/app/dashboard/calendar?action=#{currentEvent.id}&amp;eventId=#{appointment.id}&amp;eventBegin=#{appointment.begin}&amp;eventEnd=#{appointment.end}"/>
    <end-state id="cancel"
               view="externalRedirect:/app/dashboard/calendar?action=#{currentEvent.id}"/>

</flow>